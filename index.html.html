<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Note App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary {
            @apply bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md transition-colors;
        }
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md transition-colors;
        }
        .btn-danger {
            @apply bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-md transition-colors;
        }
        .form-input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500;
        }
        .form-textarea {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none;
        }
        .table-header {
            @apply bg-indigo-50 text-indigo-700 font-semibold;
        }
        .table-cell {
            @apply border border-gray-300 px-4 py-3;
        }
        .export-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .export-table th, .export-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .export-table th {
            background-color: #f8fafc;
            color: #4f46e5;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        // Generate UUID for session IDs
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Main App Component
        const TrainingNoteApp = () => {
            const [currentView, setCurrentView] = React.useState('dashboard');
            const [sessions, setSessions] = React.useState([]);
            const [currentSession, setCurrentSession] = React.useState(null);
            const [searchTerm, setSearchTerm] = React.useState('');

            // Load sessions from localStorage on initial render
            React.useEffect(() => {
                const savedSessions = localStorage.getItem('trainingSessions');
                if (savedSessions) {
                    setSessions(JSON.parse(savedSessions));
                }
            }, []);

            // Save sessions to localStorage whenever sessions change
            React.useEffect(() => {
                localStorage.setItem('trainingSessions', JSON.stringify(sessions));
            }, [sessions]);

            // Navigate to create new session
            const createNewSession = () => {
                setCurrentSession({
                    id: generateUUID(),
                    date: new Date().toISOString().split('T')[0],
                    title: '',
                    items: [{
                        itemName: '',
                        sop: '',
                        notes: '',
                        packaging: '',
                        photo: null
                    }]
                });
                setCurrentView('edit');
            };

            // Navigate to edit existing session
            const editSession = (sessionId) => {
                const session = sessions.find(s => s.id === sessionId);
                if (session) {
                    setCurrentSession(JSON.parse(JSON.stringify(session))); // Deep clone
                    setCurrentView('edit');
                }
            };

            // Navigate to review session
            const reviewSession = (sessionId) => {
                const session = sessions.find(s => s.id === sessionId);
                if (session) {
                    setCurrentSession(session);
                    setCurrentView('review');
                }
            };

            // Save session and return to dashboard
            const saveSession = () => {
                if (!currentSession.title.trim()) {
                    alert('Please enter a training title');
                    return;
                }

                const existingIndex = sessions.findIndex(s => s.id === currentSession.id);
                let updatedSessions;

                if (existingIndex >= 0) {
                    // Update existing session
                    updatedSessions = [...sessions];
                    updatedSessions[existingIndex] = currentSession;
                } else {
                    // Add new session
                    updatedSessions = [...sessions, currentSession];
                }

                setSessions(updatedSessions);
                setCurrentView('dashboard');
            };

            // Delete session
            const deleteSession = (sessionId) => {
                if (confirm('Are you sure you want to delete this session?')) {
                    const updatedSessions = sessions.filter(s => s.id !== sessionId);
                    setSessions(updatedSessions);
                }
            };

            // Add new training item
            const addTrainingItem = () => {
                setCurrentSession(prev => ({
                    ...prev,
                    items: [
                        ...prev.items,
                        {
                            itemName: '',
                            sop: '',
                            notes: '',
                            packaging: '',
                            photo: null
                        }
                    ]
                }));
            };

            // Remove training item
            const removeTrainingItem = (index) => {
                if (currentSession.items.length <= 1) {
                    alert('At least one training item is required');
                    return;
                }

                setCurrentSession(prev => ({
                    ...prev,
                    items: prev.items.filter((_, i) => i !== index)
                }));
            };

            // Update training item field
            const updateTrainingItem = (index, field, value) => {
                setCurrentSession(prev => ({
                    ...prev,
                    items: prev.items.map((item, i) => 
                        i === index ? { ...item, [field]: value } : item
                    )
                }));
            };

            // Handle file upload
            const handleFileUpload = (index, file) => {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        updateTrainingItem(index, 'photo', e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Export to PDF with photos
            const exportToPDF = async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.setTextColor(79, 70, 229);
                doc.text(`Training Session: ${currentSession.title}`, 20, 20);
                
                // Add date
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Date: ${new Date(currentSession.date).toLocaleDateString()}`, 20, 30);
                
                let yPosition = 50;
                
                // Add each training item
                for (let index = 0; index < currentSession.items.length; index++) {
                    const item = currentSession.items[index];
                    
                    // Add item header
                    doc.setFontSize(16);
                    doc.setTextColor(79, 70, 229);
                    doc.text(`Item ${index + 1}: ${item.itemName}`, 20, yPosition);
                    yPosition += 10;
                    
                    // Add SOP
                    if (item.sop) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        const sopLines = doc.splitTextToSize(`SOP/Condiments: ${item.sop}`, 170);
                        doc.text(sopLines, 20, yPosition);
                        yPosition += sopLines.length * 7;
                    }
                    
                    // Add Notes
                    if (item.notes) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        const notesLines = doc.splitTextToSize(`Notes/Feedback: ${item.notes}`, 170);
                        doc.text(notesLines, 20, yPosition);
                        yPosition += notesLines.length * 7;
                    }
                    
                    // Add Packaging
                    if (item.packaging) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        const packagingLines = doc.splitTextToSize(`Packaging: ${item.packaging}`, 170);
                        doc.text(packagingLines, 20, yPosition);
                        yPosition += packagingLines.length * 7;
                    }
                    
                    // Add Photo if exists
                    if (item.photo) {
                        try {
                            // Add photo label
                            doc.setFontSize(12);
                            doc.setTextColor(0, 0, 0);
                            doc.text('Photo:', 20, yPosition);
                            yPosition += 5;
                            
                            // Add the image - limit size to fit in PDF
                            const imgProps = doc.getImageProperties(item.photo);
                            const width = 40;
                            const height = (imgProps.height * width) / imgProps.width;
                            
                            doc.addImage(item.photo, 'JPEG', 20, yPosition, width, height);
                            yPosition += height + 10;
                        } catch (error) {
                            console.error('Error adding image to PDF:', error);
                            doc.text('Photo: [Error loading image]', 20, yPosition);
                            yPosition += 10;
                        }
                    }
                    
                    yPosition += 10;
                    
                    // Add page break if needed
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                    }
                }
                
                doc.save(`Training_${currentSession.title.replace(/\s+/g, '_')}.pdf`);
            };

            // Export to Word with photos
            const exportToWord = () => {
                // Create HTML content for the document
                let htmlContent = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" 
                          xmlns:w="urn:schemas-microsoft-com:office:word" 
                          xmlns="http://www.w3.org/TR/REC-html40">
                    <head>
                        <meta charset="utf-8">
                        <title>Training Session: ${currentSession.title}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: #4f46e5; font-size: 24px; margin-bottom: 10px; }
                            h2 { color: #4f46e5; font-size: 18px; margin-top: 20px; margin-bottom: 10px; }
                            h3 { color: #4f46e5; font-size: 16px; margin-top: 15px; }
                            p { margin: 5px 0; }
                            .section { margin-bottom: 20px; }
                            .item { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; }
                            .field { margin-bottom: 10px; }
                            .field-title { font-weight: bold; color: #555; }
                            .photo-container { margin-top: 10px; }
                            .photo { max-width: 200px; max-height: 150px; }
                            table.export-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                            table.export-table th, table.export-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            table.export-table th { background-color: #f8fafc; color: #4f46e5; font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        <h1>Training Session: ${currentSession.title}</h1>
                        <p><strong>Date:</strong> ${new Date(currentSession.date).toLocaleDateString()}</p>
                        <div class="section">
                            <table class="export-table">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>SOP / Condiments</th>
                                        <th>Notes / Feedback</th>
                                        <th>Packaging</th>
                                        <th>Photo</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                // Add each training item as table rows
                currentSession.items.forEach((item, index) => {
                    htmlContent += `
                        <tr>
                            <td>${item.itemName || 'N/A'}</td>
                            <td>${item.sop || 'N/A'}</td>
                            <td>${item.notes || 'N/A'}</td>
                            <td>${item.packaging || 'N/A'}</td>
                            <td>
                    `;
                    
                    if (item.photo) {
                        htmlContent += `<div class="photo-container"><img src="${item.photo}" alt="Training item photo" class="photo" /></div>`;
                    } else {
                        htmlContent += 'N/A';
                    }
                    
                    htmlContent += `
                            </td>
                        </tr>
                    `;
                });
                
                htmlContent += `
                                </tbody>
                            </table>
                        </div>
                    </body>
                    </html>
                `;
                
                // Create Blob and download
                const blob = new Blob([htmlContent], { 
                    type: 'application/msword;charset=utf-8' 
                });
                
                // Use FileSaver to save the file
                saveAs(blob, `Training_${currentSession.title.replace(/\s+/g, '_')}.doc`);
            };

            // Alternative export using html2canvas for better formatting
            const exportAsImagePDF = () => {
                const element = document.getElementById('review-content');
                
                html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 295; // A4 height in mm
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(`Training_${currentSession.title.replace(/\s+/g, '_')}.pdf`);
                });
            };

            // Filter sessions based on search term
            const filteredSessions = sessions.filter(session => 
                session.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                session.date.includes(searchTerm)
            );

            // Render Dashboard
            const renderDashboard = () => (
                <div className="max-w-4xl mx-auto p-6">
                    <div className="flex justify-between items-center mb-8">
                        <h1 className="text-3xl font-bold text-indigo-700">Training Note App</h1>
                        <button 
                            className="btn-primary"
                            onClick={createNewSession}
                        >
                            Create New Session
                        </button>
                    </div>

                    {/* Search Bar */}
                    <div className="mb-6">
                        <input
                            type="text"
                            placeholder="Search by title or date..."
                            className="form-input"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>

                    {/* Sessions List */}
                    {filteredSessions.length === 0 ? (
                        <div className="bg-white rounded-lg card-shadow p-8 text-center">
                            <p className="text-gray-500">No training sessions found. Create your first session!</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {filteredSessions.map(session => (
                                <div key={session.id} className="bg-white rounded-lg card-shadow p-4">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h3 className="text-lg font-semibold text-indigo-700">{session.title}</h3>
                                            <p className="text-gray-500">
                                                {new Date(session.date).toLocaleDateString()}
                                            </p>
                                        </div>
                                        <div className="space-x-2">
                                            <button 
                                                className="btn-secondary"
                                                onClick={() => reviewSession(session.id)}
                                            >
                                                Review
                                            </button>
                                            <button 
                                                className="btn-primary"
                                                onClick={() => editSession(session.id)}
                                            >
                                                Edit
                                            </button>
                                            <button 
                                                className="btn-danger"
                                                onClick={() => deleteSession(session.id)}
                                            >
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );

            // Render Edit Session Form
            const renderEditSession = () => (
                <div className="max-w-4xl mx-auto p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-bold text-indigo-700">
                            {currentSession.id && sessions.some(s => s.id === currentSession.id) ? 'Edit' : 'Create'} Training Session
                        </h1>
                        <button 
                            className="btn-secondary"
                            onClick={() => setCurrentView('dashboard')}
                        >
                            ← Dashboard
                        </button>
                    </div>

                    <div className="bg-white rounded-lg card-shadow p-6 mb-6">
                        <h2 className="text-xl font-semibold text-indigo-700 mb-4">Session Details</h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Training Date
                                </label>
                                <input
                                    type="date"
                                    className="form-input"
                                    value={currentSession.date}
                                    onChange={(e) => setCurrentSession({...currentSession, date: e.target.value})}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Training Title
                                </label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="Enter training title"
                                    value={currentSession.title}
                                    onChange={(e) => setCurrentSession({...currentSession, title: e.target.value})}
                                />
                            </div>
                        </div>

                        <h2 className="text-xl font-semibold text-indigo-700 mb-4">Training Items</h2>
                        
                        {currentSession.items.map((item, index) => (
                            <div key={index} className="border border-gray-200 rounded-lg p-4 mb-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-medium text-indigo-700">Item {index + 1}</h3>
                                    <button 
                                        className="btn-danger"
                                        onClick={() => removeTrainingItem(index)}
                                    >
                                        Remove
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Item Name
                                        </label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="Enter item name"
                                            value={item.itemName}
                                            onChange={(e) => updateTrainingItem(index, 'itemName', e.target.value)}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            SOP / Condiments
                                        </label>
                                        <textarea
                                            rows="3"
                                            className="form-textarea"
                                            placeholder="Enter SOP or condiments details"
                                            value={item.sop}
                                            onChange={(e) => updateTrainingItem(index, 'sop', e.target.value)}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Notes / Feedback
                                        </label>
                                        <textarea
                                            rows="3"
                                            className="form-textarea"
                                            placeholder="Enter notes or feedback"
                                            value={item.notes}
                                            onChange={(e) => updateTrainingItem(index, 'notes', e.target.value)}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Packaging
                                        </label>
                                        <textarea
                                            rows="2"
                                            className="form-textarea"
                                            placeholder="Enter packaging details"
                                            value={item.packaging}
                                            onChange={(e) => updateTrainingItem(index, 'packaging', e.target.value)}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Photo (Optional)
                                        </label>
                                        <input
                                            type="file"
                                            className="form-input"
                                            accept="image/*"
                                            onChange={(e) => handleFileUpload(index, e.target.files[0])}
                                        />
                                        {item.photo && (
                                            <div className="mt-2">
                                                <img 
                                                    src={item.photo} 
                                                    alt="Uploaded preview" 
                                                    className="h-32 object-cover rounded-md"
                                                />
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                        
                        <div className="flex justify-between mt-6">
                            <button 
                                className="btn-primary"
                                onClick={addTrainingItem}
                            >
                                + Add Item
                            </button>
                            <button 
                                className="btn-primary"
                                onClick={saveSession}
                            >
                                Save and Review
                            </button>
                        </div>
                    </div>
                </div>
            );

            // Render Review Session
            const renderReviewSession = () => (
                <div className="max-w-6xl mx-auto p-6">
                    <div id="review-content" className="bg-white rounded-lg card-shadow p-8">
                        {/* Title Section */}
                        <div className="mb-8 text-center">
                            <h1 className="text-4xl font-bold text-indigo-700 mb-2"># {currentSession.title}</h1>
                            <p className="text-lg text-gray-600">
                                Date: {new Date(currentSession.date).toLocaleDateString()}
                            </p>
                        </div>

                        {/* Table Section */}
                        <div className="overflow-x-auto mb-8">
                            <table className="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr className="table-header">
                                        <th className="table-cell text-left">Item Name</th>
                                        <th className="table-cell text-left">SOP / Condiments</th>
                                        <th className="table-cell text-left">Notes / Feedback</th>
                                        <th className="table-cell text-left">Packaging</th>
                                        <th className="table-cell text-left">Photo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {currentSession.items.map((item, index) => (
                                        <tr key={index} className="hover:bg-gray-50">
                                            <td className="table-cell">
                                                <div className="font-medium text-gray-900">{item.itemName}</div>
                                            </td>
                                            <td className="table-cell">
                                                <div className="text-gray-700 whitespace-pre-wrap">{item.sop || 'N/A'}</div>
                                            </td>
                                            <td className="table-cell">
                                                <div className="text-gray-700 whitespace-pre-wrap">{item.notes || 'N/A'}</div>
                                            </td>
                                            <td className="table-cell">
                                                <div className="text-gray-700 whitespace-pre-wrap">{item.packaging || 'N/A'}</div>
                                            </td>
                                            <td className="table-cell">
                                                {item.photo ? (
                                                    <img 
                                                        src={item.photo} 
                                                        alt="Training item" 
                                                        className="h-20 w-20 object-cover rounded-md mx-auto"
                                                    />
                                                ) : (
                                                    <div className="text-gray-400 text-center">N/A</div>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* Divider */}
                        <div className="border-t border-gray-300 my-8"></div>

                        {/* Action Buttons */}
                        <div className="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                            <button 
                                className="btn-secondary w-full sm:w-auto"
                                onClick={() => setCurrentView('dashboard')}
                            >
                                ← Back to Dashboard
                            </button>
                            <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                                <button 
                                    className="btn-primary w-full sm:w-auto flex items-center justify-center"
                                    onClick={exportToPDF}
                                >
                                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Export as PDF
                                </button>
                                <button 
                                    className="btn-primary w-full sm:w-auto flex items-center justify-center"
                                    onClick={exportToWord}
                                >
                                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Export as DOCX
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            // Render current view
            return (
                <div>
                    {currentView === 'dashboard' && renderDashboard()}
                    {currentView === 'edit' && renderEditSession()}
                    {currentView === 'review' && renderReviewSession()}
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<TrainingNoteApp />, document.getElementById('root'));
    </script>
</body>
</html>